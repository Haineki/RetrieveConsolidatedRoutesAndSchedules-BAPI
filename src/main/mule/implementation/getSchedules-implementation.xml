<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	<sub-flow name="getSchedules-CallTravelOnTip-subFlow" doc:id="830b6e69-0ab8-4484-83c4-8df9668f1de7" >
		<set-variable value="#[&quot;/api/&quot; ++ (vars.transportType default &quot; &quot;) ++ p('http.requester.travelOnTip.routesPath')]" doc:name="Set Variable" doc:id="dba0ae32-1014-43fc-ac40-9830c1996e6e" variableName="resourcePath" />
		<ee:cache doc:name="Cache" doc:id="03c3acca-7caf-4f73-a5e7-8be8192b04f6" cachingStrategy-ref="Caching_Strategy">
					<http:request method="GET" doc:name="Request" doc:id="35e92c3f-11f7-4bd0-9f94-4ccd974f87bd" config-ref="HTTP_Request_configuration_TravelOnTip-SAPI" path="#[vars.resourcePath]">
						<http:headers><![CDATA[#[output application/java
---
{
	"transactionId" : vars.transactionId
}]]]></http:headers>
					</http:request>
					<ee:transform doc:name="Transform Message" doc:id="17f96479-a8ca-4d04-9b22-aacdc4ae6f02">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
var LocationMapping = (readUrl("classpath://json/LocationCodeMapping.json","application/json"))
---
payload map (value, index)->(
    {
    "companyName": "TravelOnTip",
    "availableSeats": value.availableSeats,
    "departureDateTime": value.departureDateTime,
    "travelRoute": {
      "destinationLocation": {
        "locationDesc": (LocationMapping filter ($.locationCode == value.travelRoute.destinationLocation.locationCode))[0].locationDesc
      },
      "originLocation": {
        "locationDesc": (LocationMapping filter ($.locationCode == value.travelRoute.originLocation.locationCode))[0].locationDesc
      }
    }
  }
)]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				</ee:cache>
	</sub-flow>
	<sub-flow name="getSchedules-CallFastGo-subFlow" doc:id="daf9cb7f-7ecf-4767-b471-3ce5e4e3b447" >
		<set-variable value="#[&quot;/api/&quot; ++ (vars.transportType default &quot; &quot;) ++ p('http.requester.fastGo.routesPath')]" doc:name="Set Variable" doc:id="bd01ed0c-777f-4d4b-84d0-45f899f7d98f" variableName="resourcePath" />
		<ee:cache doc:name="Cache" doc:id="97c87d58-5e81-4a1a-9d47-09bc08151c2e" cachingStrategy-ref="Caching_Strategy">
					<http:request method="GET" doc:name="Request" doc:id="ed016d78-cab2-48e9-bd49-ef22e0efae75" config-ref="HTTP_Request_configuration_FastGo-SAPI" path="#[vars.resourcePath]">
					<http:headers><![CDATA[#[output application/java
---
{
	"transactionId" : vars.transactionId
}]]]></http:headers>
				</http:request>
					<ee:transform doc:name="Transform Message" doc:id="e842fad2-8254-47d5-9351-71e5f1712d86">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
var LocationMapping = (readUrl("classpath://json/LocationCodeMapping.json","application/json"))
---
payload map (value, index)->(
    {
    "companyName": "FastGo",
    "availableSeats": value.availableSeats,
    "departureDateTime": value.departureDateTime,
    "travelRoute": {
      "destinationLocation": {
        "locationDesc": (LocationMapping filter ($.locationCode == value.toLocation))[0].locationDesc
      },
      "originLocation": {
        "locationDesc": (LocationMapping filter ($.locationCode == value.fromLocation))[0].locationDesc
      }
    }
  }
)]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				</ee:cache>
	</sub-flow>
	<sub-flow name="getSchedules-implementationSub_Flow" doc:id="15072bab-61e6-4056-bcfe-730f68e3a90b" >
		<set-variable value="Routes" doc:name="Set Variable" doc:id="5dbed380-40f0-4d63-be4d-13076d0ccaa7" variableName="resource"/>
		<choice doc:name="Choice" doc:id="97ce188f-c3a5-444b-8003-78c62885ee57" >
			<when expression="#[vars.transportCompany == 'TravelOnTip']">
				<flow-ref doc:name="Flow Reference" doc:id="e39dc280-47c5-4f7f-bb9d-bc187ecac47b" name="getRoutes-CallTravelOnTip-subFlow" />
			</when>
			<when expression="#[vars.transportCompany == 'FastGo']">
				<flow-ref doc:name="Flow Reference" doc:id="09665968-352e-4677-9276-a97a5e1fcf47" name="getRoutes-CallFastGo-subFlow" />
			</when>
			<otherwise >
				<scatter-gather doc:name="Scatter-Gather" doc:id="dce32953-7b0a-4960-a7ac-da4c9d81c94f" >
					<route >
						<set-variable value="TravelOnTip" doc:name="Set Variable" doc:id="d11b7842-f418-459a-8f5c-92db11c555ce" variableName="transportCompany"/>
						<flow-ref doc:name="Flow Reference" doc:id="728c39c8-29ea-4a94-9346-adde34476904" name="getRoutes-CallTravelOnTip-subFlow" />
					</route>
					<route >
						<set-variable value="FastGo" doc:name="Set Variable" doc:id="e576357e-fe95-4ea1-8a9b-6b3ba3dd40f1" variableName="transportCompany"/>
						<flow-ref doc:name="Flow Reference" doc:id="99d71a7b-be1b-4886-b9fa-defc8f5cd082" name="getRoutes-CallFastGo-subFlow"/>
					</route>
				</scatter-gather>
				<set-payload value="#[%dw 2.0&#10;output application/json&#10;---&#10;(payload.'0'.payload default []) ++ (payload.'1'.payload default [])]" doc:name="Set Payload" doc:id="16350fe1-f2b6-4380-94d8-27b5f9be5be0" />
			</otherwise>
		</choice>
	</sub-flow>
</mule>
