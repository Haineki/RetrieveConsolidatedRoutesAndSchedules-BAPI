<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="getRoutes-CallTravelOnTip-subFlow" doc:id="2bcc3a06-2272-4aec-899d-cfe50e1fd6dc" >
		<set-variable value="#[&quot;/api/&quot; ++ (vars.transportType default &quot; &quot;) ++ p('http.requester.travelOnTip.routesPath')]" doc:name="Set Variable" doc:id="a884281f-6b9c-47fd-833e-8eb81665c92b" variableName="resourcePath" />
		<ee:cache doc:name="Cache" doc:id="d11da117-4799-4994-a84a-edf6d4f4fc46" cachingStrategy-ref="Caching_Strategy">
					<http:request method="GET" doc:name="Request" doc:id="08f8f99d-3b61-47d0-9088-43db6779240b" config-ref="HTTP_Request_configuration_TravelOnTip-SAPI" path="#[vars.resourcePath]">
						<http:headers><![CDATA[#[output application/java
---
{
	"transactionId" : vars.transactionId
}]]]></http:headers>
					</http:request>
					<ee:transform doc:name="Transform Message" doc:id="509e4c05-3be3-4c1b-8c24-9c393d964da4">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
var LocationMapping = (readUrl("classpath://json/LocationCodeMapping.json","application/json"))
---
payload map (value, index)->(
    {
    "companyCode": vars.transportCompany,
    "originLocation": {
      "locationCode": value.originLocation.locationCode,
      "locationDesc": (LocationMapping filter ($.locationCode == value.originLocation.locationCode))[0].locationDesc
    },
    "destinationLocation": {
      "locationCode": value.destinationLocation.locationCode,
      "locationDesc": (LocationMapping filter ($.locationCode == value.destinationLocation.locationCode))[0].locationDesc
    }
  }
)]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				</ee:cache>
	</sub-flow>
	<sub-flow name="getRoutes-CallFastGo-subFlow" doc:id="d6a70985-aeeb-45de-a54b-de8a2bf0cbee" >
		<set-variable value="#[&quot;/api/&quot; ++ (vars.transportType default &quot; &quot;) ++ p('http.requester.fastGo.routesPath')]" doc:name="Set Variable" doc:id="c50ea8e2-efb4-434b-96ad-d368e975d5b5" variableName="resourcePath" />
		<ee:cache doc:name="Cache" doc:id="210f058d-fd86-43ca-a04b-b5d495a894ad" cachingStrategy-ref="Caching_Strategy">
					<http:request method="GET" doc:name="Request" doc:id="6b03965f-0bc4-4072-b15a-244dbc35ba16" config-ref="HTTP_Request_configuration_FastGo-SAPI" path="#[vars.resourcePath]">
					<http:headers><![CDATA[#[output application/java
---
{
	"transactionId" : vars.transactionId
}]]]></http:headers>
				</http:request>
					<ee:transform doc:name="Transform Message" doc:id="8f9feedb-6b9c-42fa-a2c9-7ae636e9a632">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
var LocationMapping = (readUrl("classpath://json/LocationCodeMapping.json","application/json"))
---
payload map(value, index)->(
    {
    "companyCode": vars.transportCompany,
    "originLocation": {
      "locationCode": value.departureLocationCode,
      "locationDesc": (LocationMapping filter ($.locationCode == value.departureLocationCode))[0].locationDesc
    },
    "destinationLocation": {
      "locationCode": value.arrivalLocationCode,
      "locationDesc": (LocationMapping filter ($.locationCode == value.arrivalLocationCode))[0].locationDesc
    }
  }
)]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				</ee:cache>
	</sub-flow>
	<sub-flow name="getRoutes-implementationSub_Flow" doc:id="227f8371-1eb4-4a9e-a553-5b7ec0b64763" >
		<set-variable value="Routes" doc:name="Set Variable" doc:id="d5b7c250-3071-44d9-bdfd-e25db32316f9" variableName="resource"/>
		<choice doc:name="Choice" doc:id="a16d9192-9c38-48e6-8248-11157a70d80d" >
			<when expression="#[vars.transportCompany == 'TravelOnTip']">
				<flow-ref doc:name="Flow Reference" doc:id="c3a2700f-266f-4bcd-9094-569faa6b5ea3" name="getRoutes-CallTravelOnTip-subFlow" />
			</when>
			<when expression="#[vars.transportCompany == 'FastGo']">
				<flow-ref doc:name="Flow Reference" doc:id="4a163ba6-761d-4396-a906-39e2256238fc" name="getRoutes-CallFastGo-subFlow" />
			</when>
			<otherwise >
				<scatter-gather doc:name="Scatter-Gather" doc:id="03df95dc-0555-4681-a4d4-cba5d4386bce" >
					<route >
						<set-variable value="TravelOnTip" doc:name="Set Variable" doc:id="cc35cb96-357f-4e28-898e-0e27efcf3494" variableName="transportCompany"/>
						<flow-ref doc:name="Flow Reference" doc:id="ed852b5d-1573-43c3-9039-0aa6b72319de" name="getRoutes-CallTravelOnTip-subFlow" />
					</route>
					<route >
						<set-variable value="FastGo" doc:name="Set Variable" doc:id="ca171322-7603-4671-ba85-1f4dbc6d465e" variableName="transportCompany"/>
						<flow-ref doc:name="Flow Reference" doc:id="4a549b8f-adc2-4a0a-a485-c3ffac3f1aea" name="getRoutes-CallFastGo-subFlow"/>
					</route>
				</scatter-gather>
				<set-payload value="#[%dw 2.0&#10;output application/json&#10;---&#10;(payload.'0'.payload default []) ++ (payload.'1'.payload default [])]" doc:name="Set Payload" doc:id="80e2711a-ad42-4be1-a213-70150f63841a" />
			</otherwise>
		</choice>
	</sub-flow>
</mule>